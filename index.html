<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Mağaza Performans Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f3f6f9; }
    .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); border: 1px solid white; }
    .input-style { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; transition: all 0.2s; font-size: 14px; }
    .input-style:focus { border-color: #10b981; ring: 2px; ring-color: #10b981; outline: none; background: white; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    th { background-color: #f8fafc; color: #64748b; font-weight: 700; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; padding: 16px; border-bottom: 1px solid #e2e8f0; }
    td { padding: 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #1e293b; }
    .trend-up { color: #10b981; font-weight: 700; }
    .trend-down { color: #f43f5e; font-weight: 700; }
  </style>
</head>
<body class="antialiased text-slate-800">

  <div class="max-w-7xl mx-auto px-4 py-8 space-y-6">
    <header class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-6 rounded-[1.5rem] shadow-sm border border-white">
      <div>
        <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight">Performans Karşılaştırma Paneli</h1>
        <p id="dateRangeText" class="text-slate-400 text-sm font-medium mt-1 italic">Veriler yükleniyor...</p>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="refreshDashboard()" class="p-2.5 bg-slate-100 hover:bg-slate-200 rounded-xl transition-all" title="Verileri Yenile">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
        </button>
        <button onclick="downloadPDF()" id="pdfBtn" class="bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold hover:bg-emerald-700 shadow-lg transition-all flex items-center gap-2">
          PDF Raporu
        </button>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="card p-6 flex flex-col gap-4">
        <div class="flex justify-between items-center">
          <h2 class="text-sm font-bold text-emerald-800 uppercase tracking-widest">Tarih Aralığı Seç</h2>
          <button onclick="resetToLatest()" class="text-[10px] font-bold text-slate-400 hover:text-emerald-600 transition-colors uppercase">Son Periyoda Git</button>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="space-y-1">
            <span class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Başlangıç</span>
            <input type="date" id="filterStart" class="w-full input-style" onchange="applyFilter()">
          </div>
          <div class="space-y-1">
            <span class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Bitiş</span>
            <input type="date" id="filterEnd" class="w-full input-style" onchange="applyFilter()">
          </div>
        </div>
      </section>

      <section class="lg:col-span-2 card p-6">
        <h2 class="text-sm font-bold text-emerald-800 uppercase tracking-widest mb-4">Hızlı Veri Girişi</h2>
        <form id="dataForm" class="flex flex-wrap items-end gap-3">
          <input type="date" id="tarih" required class="input-style flex-1 min-w-[120px]">
          <select id="magaza" class="input-style flex-1 min-w-[150px]">
            <option>Paşabahçe</option><option>Kavacık</option><option>Çekmeköy</option>
            <option>Yenidoğan</option><option>Sultanbeyli</option><option>Çayırova</option>
            <option>Körfez</option><option>Derince</option><option>İzmit</option>
            <option>Gölcük</option><option>İnegöl</option>
          </select>
          <input type="number" id="yorum" placeholder="Yorum" required class="input-style w-24">
          <input type="number" id="puan" step="0.1" min="1" max="5" placeholder="Puan" required class="input-style w-20">
          <button type="submit" id="submitBtn" class="bg-slate-800 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-900 transition-all">Kaydet</button>
        </form>
      </section>
    </div>

    <section class="card overflow-hidden shadow-sm">
      <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
        <h2 class="text-lg font-bold text-slate-800">Şube Performans Karşılaştırma Tablosu</h2>
        <div id="loader" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-emerald-600"></div>
      </div>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th class="text-left">Mağaza Adı</th>
              <th class="text-center">Önceki Yorum</th>
              <th class="text-center">Önceki Puan</th>
              <th class="text-center">Yeni Yorum</th>
              <th class="text-center">Yeni Puan</th>
              <th class="text-center">Yorum Farkı</th>
              <th class="text-center">Puan Farkı</th>
              <th class="text-right">Puan Değişimi %</th>
            </tr>
          </thead>
          <tbody id="dataTable"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz29zzy7qchsQTHaV6DYR10W6xoGgRWyy5OSlqZAlQ_I-I-fAX96N6ExR72St0fXUgcOA/exec";
    let fullData = []; 
    // PDF için ekrandaki veriyi saklayacak değişken
    let pdfExportData = [];

    window.onload = () => {
      refreshDashboard();
    };

    function resetToLatest() {
      if (fullData.length > 0) {
        const uniqueDates = [...new Set(fullData.map(row => {
            const d = new Date(row[0]);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }))].sort();

        const lastDateStr = uniqueDates[uniqueDates.length - 1];
        const startDateStr = uniqueDates.length > 1 ? uniqueDates[uniqueDates.length - 2] : lastDateStr;

        document.getElementById('filterStart').value = startDateStr;
        document.getElementById('filterEnd').value = lastDateStr;
        document.getElementById('tarih').value = lastDateStr;
        
        applyFilter();
      }
    }

    async function apiCall(action, params = {}) {
      const url = new URL(API_URL);
      url.searchParams.append('action', action);
      url.searchParams.append('_t', Date.now()); 
      
      Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
      
      try {
        const response = await fetch(url.toString(), {
          method: "GET",
          redirect: "follow"
        });

        if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

        const text = await response.text();
        try {
          return JSON.parse(text);
        } catch (e) {
          if (action === 'submitData') return { success: true };
          throw new Error("Sunucudan geçerli veri alınamadı.");
        }
      } catch (error) {
        console.error("API Hatası:", error);
        throw error;
      }
    }

    async function refreshDashboard() {
      const loader = document.getElementById('loader');
      const tableBody = document.getElementById('dataTable');
      loader.classList.remove('hidden');
      
      try {
        fullData = await apiCall('getDashboardData');
        
        if (!Array.isArray(fullData)) {
            if (fullData && fullData.success === false) throw new Error(fullData.error);
            fullData = []; 
        }

        fullData.sort((a, b) => new Date(a[0]) - new Date(b[0]));
        resetToLatest();
        
      } catch (e) {
        console.error("Dashboard yüklenemedi", e);
        tableBody.innerHTML = `<tr><td colspan="8" class="p-10 text-center text-red-500 font-bold">Veri yüklenemedi: ${e.message}</td></tr>`;
      } finally {
        loader.classList.add('hidden');
      }
    }

    function applyFilter() {
      const startVal = document.getElementById('filterStart').value;
      const endVal = document.getElementById('filterEnd').value;
      
      if (!startVal || !endVal) return;

      const start = new Date(startVal);
      start.setHours(0, 0, 0, 0);
      
      const end = new Date(endVal);
      end.setHours(23, 59, 59, 999);

      document.getElementById('dateRangeText').innerText = `${start.toLocaleDateString('tr-TR')} - ${end.toLocaleDateString('tr-TR')} aralığı`;

      const filtered = fullData.filter(row => {
        const d = new Date(row[0]);
        return d >= start && d <= end;
      });

      updateUI(filtered);
    }

    function updateUI(filtered) {
      const tableBody = document.getElementById('dataTable');
      tableBody.innerHTML = '';
      pdfExportData = []; // PDF verisini sıfırla
      
      if (!filtered || filtered.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="p-20 text-center text-slate-400 font-medium">Bu tarihte veri bulunamadı.</td></tr>';
        return;
      }

      const stores = {};
      
      filtered.forEach(row => {
        const date = new Date(row[0]);
        const name = row[1];
        const comments = parseInt(row[2]) || 0;
        const score = parseFloat(row[3]) || 0;

        if (!stores[name] || date >= stores[name].last.date) {
          const prevRecord = fullData
            .filter(r => r[1] === name && new Date(r[0]) < date)
            .pop();

          stores[name] = {
            last: { date, comments, score },
            prev: prevRecord ? 
              { comments: parseInt(prevRecord[2]), score: parseFloat(prevRecord[3]) } : 
              { comments, score }
          };
        }
      });

      Object.keys(stores).sort().forEach(name => {
        const s = stores[name];
        const cDiff = s.last.comments - s.prev.comments;
        const sDiff = s.last.score - s.prev.score;
        
        let pChange = "0.0";
        if (s.prev.score > 0) {
             pChange = ((sDiff / s.prev.score) * 100).toFixed(1);
        }

        // PDF için veriyi sakla
        pdfExportData.push({
            name: name,
            prevC: s.prev.comments,
            prevS: s.prev.score.toFixed(1),
            newC: s.last.comments,
            newS: s.last.score.toFixed(1),
            cDiff: cDiff,
            sDiff: sDiff.toFixed(1),
            pChange: pChange
        });

        const cDiffColor = cDiff > 0 ? 'text-emerald-600' : (cDiff < 0 ? 'text-rose-600' : 'text-slate-400');
        
        let sDiffColor = "text-slate-400";
        if (sDiff > 0) sDiffColor = "text-emerald-600";
        else if (sDiff < 0) sDiffColor = "text-rose-600";

        let badgeColor = "bg-slate-100 text-slate-500"; 
        if (sDiff > 0) badgeColor = "bg-emerald-50 text-emerald-600";
        else if (sDiff < 0) badgeColor = "bg-rose-50 text-rose-600";

        const tr = document.createElement('tr');
        tr.className = "hover:bg-slate-50/50 transition-colors";
        tr.innerHTML = `
          <td class="font-bold text-slate-800">${name}</td>
          <td class="text-center text-slate-500">${s.prev.comments}</td>
          <td class="text-center text-slate-500 font-medium">${s.prev.score.toFixed(1)} ★</td>
          <td class="text-center font-bold">${s.last.comments}</td>
          <td class="text-center font-bold text-emerald-700">${s.last.score.toFixed(1)} ★</td>
          <td class="text-center font-bold ${cDiffColor}">${cDiff > 0 ? '+' : ''}${cDiff}</td>
          <td class="text-center font-bold ${sDiffColor}">${sDiff > 0 ? '+' : ''}${sDiff.toFixed(1)}</td>
          <td class="text-right"><span class="px-3 py-1 rounded-lg text-xs font-bold ${badgeColor}">% ${pChange}</span></td>
        `;
        tableBody.appendChild(tr);
      });
    }

    document.getElementById('dataForm').onsubmit = async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerText = "...";

      const formData = {
        tarih: document.getElementById('tarih').value,
        magaza: document.getElementById('magaza').value,
        yorum: document.getElementById('yorum').value,
        puan: document.getElementById('puan').value
      };

      try {
        await apiCall('submitData', formData);
        document.getElementById('dataForm').reset();
        await new Promise(r => setTimeout(r, 1500));
        await refreshDashboard(); 
      } catch (err) {
        await refreshDashboard();
      } finally {
        btn.disabled = false;
        btn.innerText = "Kaydet";
      }
    };

    async function downloadPDF() {
      const btn = document.getElementById('pdfBtn');
      btn.innerText = "Hazırlanıyor...";
      btn.disabled = true;

      // ARTIK EKRANDAKİ VERİYİ GÖNDERİYORUZ
      const reportRange = document.getElementById('dateRangeText').innerText;
      
      try {
        const base64 = await apiCall('generatePDFReport', {
            reportData: JSON.stringify(pdfExportData),
            reportRange: reportRange
        });
        
        if (base64 && base64.length > 0) {
          const link = document.createElement('a');
          link.href = 'data:application/pdf;base64,' + base64;
          link.download = 'Performans_Raporu.pdf';
          link.click();
        } else {
          alert("Rapor oluşturulamadı.");
        }
      } catch (err) {
        alert("PDF oluşturma hatası!");
      } finally {
        btn.innerText = "PDF Raporu";
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
